<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quanta 题库预览 (v3.0)</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

  <style>
      /* --- 全局样式变量 (Modern SaaS 风格) --- */
      :root {
          --primary-color: #4f46e5;       /* Indigo 600 */
          --primary-light: #eef2ff;       /* Indigo 50 */
          --text-main: #1f2937;           /* Gray 800 */
          --text-secondary: #4b5563;      /* Gray 600 */
          --text-light: #9ca3af;          /* Gray 400 */
          --bg-body: #f3f4f6;             /* Gray 100 */
          --bg-card: #ffffff;
          --border-color: #e5e7eb;        /* Gray 200 */
          --success-color: #10b981;
          --warning-color: #f59e0b;
          --danger-color: #ef4444;
          --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }

      body {
          font-family: var(--font-family);
          background-color: var(--bg-body);
          color: var(--text-main);
          line-height: 1.6;
          -webkit-font-smoothing: antialiased;
          padding: 40px 20px;
      }

      .container {
          max-width: 800px;
          margin: 0 auto;
      }

      /* --- 头部样式 --- */
      header { margin-bottom: 40px; text-align: center; }
      h1 { font-size: 2rem; font-weight: 800; color: #111827; margin-bottom: 8px; letter-spacing: -0.025em; }
      .subtitle { color: var(--text-secondary); font-size: 1rem; }

      /* --- 卡片通用样式 --- */
      .question-card {
          background: var(--bg-card);
          border-radius: 16px;
          box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
          border: 1px solid var(--border-color);
          padding: 32px;
          margin-bottom: 32px;
          transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .question-card:hover {
          box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
      }

      /* --- 题目元数据 (Meta) --- */
      .card-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 20px;
          padding-bottom: 16px;
          border-bottom: 1px solid var(--border-color);
      }
      .q-id {
          font-family: 'SF Mono', monospace;
          font-size: 0.85rem;
          font-weight: 600;
          color: var(--text-light);
          text-transform: uppercase;
      }
      .tags { display: flex; gap: 8px; }
      .tag { font-size: 0.75rem; padding: 4px 10px; border-radius: 99px; font-weight: 600; }
      .tag-diff { background: var(--primary-light); color: var(--primary-color); }
      .tag-type { background: #f3f4f6; color: var(--text-secondary); }

      /* --- 富文本内容 (RichContent) --- */
      .content-text { font-size: 1.1rem; color: var(--text-main); margin-bottom: 16px; white-space: pre-wrap; }
      .content-image-container {
          margin: 16px 0;
          border: 1px solid var(--border-color);
          border-radius: 8px;
          padding: 12px;
          background: #fafafa;
          display: inline-block;
          max-width: 100%;
      }
      .content-img { max-width: 100%; height: auto; display: block; border-radius: 4px; }

      /* 状态占位符 */
      .status-box {
          padding: 12px; border-radius: 8px; font-size: 0.9rem; font-family: monospace;
          margin: 10px 0; display: flex; align-items: center; gap: 8px;
      }
      .status-pending { background: #fff7ed; color: #c2410c; border: 1px dashed #fdba74; }
      .status-error { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
      .debug-msg { margin-top: 8px; font-size: 0.8rem; color: #b91c1c; white-space: pre-wrap; max-height: 100px; overflow-y: auto; }

      /* --- 选项/交互区域 (Structure) --- */
      .structure-area { margin-top: 24px; }

      .options-list { display: flex; flex-direction: column; gap: 12px; }
      .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }

      .option-item {
          display: flex; align-items: flex-start; padding: 12px 16px;
          border: 1px solid var(--border-color); border-radius: 10px;
          cursor: default; background: #fff;
      }
      .option-label {
          width: 28px; height: 28px; border-radius: 50%; background: #f3f4f6;
          color: var(--text-secondary); font-weight: 700; font-size: 0.85rem;
          display: flex; align-items: center; justify-content: center;
          margin-right: 12px; flex-shrink: 0;
      }
      .option-content { flex: 1; font-size: 1rem;}

      /* 填空/简答样式 */
      .input-placeholder {
          display: block; width: 100%; padding: 10px;
          border: 2px dashed #e5e7eb; border-radius: 8px;
          background: #f9fafb; color: #9ca3af; margin-bottom: 8px;
      }

      /* 完形填空专用样式 */
      .cloze-group { display: flex; flex-direction: column; gap: 16px; }
      .cloze-blank-box {
          border: 1px solid #e2e8f0; background: #f8fafc;
          border-radius: 10px; padding: 16px;
      }
      .cloze-blank-title {
          font-weight: 700; color: var(--primary-color); margin-bottom: 12px;
          display: flex; align-items: center; gap: 8px;
      }
      .cloze-blank-title::before {
          content: ''; display: block; width: 4px; height: 16px;
          background: var(--primary-color); border-radius: 2px;
      }

      /* --- 底部操作与解析 (Footer) --- */
      .card-footer { margin-top: 32px; padding-top: 20px; border-top: 1px solid var(--border-color); }
      .btn-toggle {
          background: #fff; border: 1px solid #d1d5db; color: #374151;
          padding: 8px 16px; border-radius: 6px; font-size: 0.9rem; font-weight: 600;
          cursor: pointer; transition: all 0.2s;
      }
      .btn-toggle:hover { background: #f3f4f6; border-color: #9ca3af; }

      .answer-area {
          margin-top: 20px; background: #f8fafc; border-radius: 8px; padding: 20px;
          border: 1px solid #e2e8f0; display: none;
      }
      .answer-area.show { display: block; }
      .answer-key { color: var(--success-color); font-weight: 800; font-size: 1.1rem; font-family: monospace; }
      .answer-label { font-size: 0.75rem; color: #6b7280; text-transform: uppercase; font-weight: 700; margin-bottom: 4px; display: block;}

      #error-banner { display: none; background: #fee2e2; color: #b91c1c; padding: 16px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>Quanta 题库预览</h1>
    <p class="subtitle">Questions Previewer v3.0 (Rich Media & Cloze Support)</p>
  </header>

  <div id="error-banner"></div>
  <div id="app">
    <div style="text-align: center; color: #9ca3af; margin-top: 50px;">
      <div style="margin-bottom:10px;">⏳</div>
      正在加载 questions.json ...
    </div>
  </div>
</div>

<script>
  const JSON_URL = './template_v2.json';

  // KaTeX 配置
  const katexOptions = {
    delimiters: [
      {left: '$$', right: '$$', display: true},
      {left: '$', right: '$', display: false},
      {left: '\\(', right: '\\)', display: false},
      {left: '\\[', right: '\\]', display: true}
    ],
    throwOnError: false
  };

  // 1. 渲染富文本 (Text + Image + CodeError)
  function renderRichContent(data) {
    if (!data) return '';
    let html = '';

    // 文本
    if (data.text) {
      // 将完形填空的占位符 {{1}} 高亮显示，方便阅读
      const highlightedText = data.text.replace(/\{\{(\w+)\}\}/g, '<span style="color:#4f46e5; font-weight:bold; background:#eef2ff; padding:0 4px; border-radius:4px; border-bottom:2px solid #4f46e5;">($1) ____</span>');
      html += `<div class="content-text">${highlightedText}</div>`;
    }

    // 错误/图片状态
    if (data.code_error) {
      html += `<div class="status-box status-error"><span>⚠️ 图片生成失败</span></div>`;
      if (data.debug_msg) html += `<div class="debug-msg">${data.debug_msg}</div>`;
    } else if (data.has_image && !data.image) {
      html += `<div class="status-box status-pending"><span>⏳ 图片待生成 (请运行 processor.py)</span></div>`;
    } else if (data.image) {
      html += `<div class="content-image-container"><img src="${data.image}" class="content-img" loading="lazy" /></div>`;
    }

    // 源码折叠
    if (data.code) {
      html += `<details style="margin-top:8px; cursor:pointer;"><summary style="font-size:0.75rem; color:#9ca3af;">查看绘图代码</summary><pre style="background:#2d2d2d; color:#fff; padding:10px; border-radius:6px; overflow-x:auto; font-size:0.75rem; margin-top:5px;">${data.code}</pre></details>`;
    }
    return html;
  }

  // 2. 渲染交互结构 (Structure)
  function renderStructure(question) {
    const type = question.type;
    const struct = question.structure;
    if (!struct) return '';

    let html = '';

    if (type === 'cloze') {
      // --- 完形填空渲染逻辑 ---
      html += `<div class="cloze-group">`;
      struct.blanks.forEach(blank => {
        html += `
                    <div class="cloze-blank-box">
                        <div class="cloze-blank-title">Blank (${blank.id})</div>
                        <div class="options-grid">
                `;
        // 选项
        if (blank.options) {
          blank.options.forEach(opt => {
            html += `
                            <div class="option-item">
                                <div class="option-label">${opt.id}</div>
                                <div class="option-content">${renderRichContent(opt)}</div>
                            </div>
                        `;
          });
        }
        html += `</div></div>`;
      });
      html += `</div>`;

    } else if (type === 'single_choice' || type === 'multiple_choice') {
      // --- 选择题渲染 ---
      const layoutClass = struct.layout === 'grid' ? 'options-grid' : 'options-list';
      html += `<div class="${layoutClass}">`;
      struct.options.forEach((opt, idx) => {
        const label = opt.id || String.fromCharCode(65 + idx);
        html += `
                    <div class="option-item">
                        <div class="option-label">${label}</div>
                        <div class="option-content">${renderRichContent(opt)}</div>
                    </div>
                `;
      });
      html += `</div>`;

    } else if (type === 'fill_blank') {
      // --- 填空题渲染 ---
      html += `<div class="options-list">`;
      struct.blanks.forEach(blank => {
        html += `<div>
                    <label style="font-weight:bold; font-size:0.85rem; color:#6b7280; margin-bottom:4px; display:block;">填空 (${blank.id}):</label>
                    <div class="input-placeholder">${blank.placeholder || '在此输入答案...'}</div>
                </div>`;
      });
      html += `</div>`;

    } else if (type === 'short_answer') {
      // --- 简答题渲染 ---
      html += `<div class="input-placeholder" style="height: 80px; display:flex; align-items:center; justify-content:center;">作答区域 (限 ${struct.max_length || '不限'} 字)</div>`;
    }

    return `<div class="structure-area">${html}</div>`;
  }

  // 3. 智能格式化答案 (自动检测并包裹 LaTeX)
  function formatAnswer(answer) {
    if (!answer) return '无答案';

    // 辅助函数：如果字符串看起来像数学公式且没有$，则加上$
    const tryWrapLatex = (str) => {
      // 简单的启发式规则：包含 = ^ \ _ { } 之一，且不包含 $
      if (typeof str === 'string' && /[\=\^\\_\{\}]/.test(str) && !str.includes('$')) {
        return `$${str}$`;
      }
      return str;
    };

    if (Array.isArray(answer)) {
      // 多选题答案 ["A", "B"]
      return answer.join(', ');
    }

    if (typeof answer === 'object') {
      // 填空题/完形填空 { "b1": ["x=1"], "2": "A" }
      return Object.entries(answer).map(([k, v]) => {
        let valStr = '';
        if (Array.isArray(v)) {
          // 填空题的多个候选答案
          valStr = v.map(tryWrapLatex).join(' <span style="color:#ccc">/</span> ');
        } else {
          // 完形填空的单个答案
          valStr = tryWrapLatex(v);
        }
        return `${k}: [ ${valStr} ]`;
      }).join('<br>');
    }

    // 单选或简答的纯字符串
    return tryWrapLatex(answer);
  }

  // 4. 主流程
  async function init() {
    try {
      const response = await fetch(JSON_URL);
      if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
      const rawData = await response.json();

      // 兼容 { question: ... } 结构或直接 Array
      const questions = Array.isArray(rawData) ? rawData : (rawData.questions || []);

      const app = document.getElementById('app');
      app.innerHTML = '';

      questions.forEach(q => {
        const card = document.createElement('div');
        card.className = 'question-card';
        card.innerHTML = `
                    <div class="card-header">
                        <span class="q-id">ID: ${q.id}</span>
                        <div class="tags">
                            <span class="tag tag-type">${q.type}</span>
                            <span class="tag tag-diff">${q.meta.difficulty || 'N/A'}</span>
                            <span class="tag tag-type">${q.meta.chapter || 'General'}</span>
                        </div>
                    </div>
                    <div class="card-body">
                        ${renderRichContent(q.content)}
                        ${renderStructure(q)}
                    </div>
                    <div class="card-footer">
                        <button class="btn-toggle" onclick="toggleAnswer(this)">查看解析</button>
                        <div class="answer-area">
                            <span class="answer-label">参考答案</span>
                            <div class="answer-key">${formatAnswer(q.validation.answer)}</div>
                            <hr style="margin: 16px 0; border: 0; border-top: 1px solid #e2e8f0;">
                            <span class="answer-label">解析</span>
                            <div>${renderRichContent(q.validation.explanation)}</div>
                        </div>
                    </div>
                `;
        app.appendChild(card);
      });

      // 渲染 LaTeX
      renderMathInElement(document.body, katexOptions);

    } catch (e) {
      const banner = document.getElementById('error-banner');
      banner.style.display = 'block';
      banner.innerHTML = `<strong>加载失败</strong><br>${e.message}<br><small>请确保 questions.json 存在且格式正确，并使用本地服务器 (python -m http.server) 运行。</small>`;
      console.error(e);
    }
  }

  window.toggleAnswer = function(btn) {
    const area = btn.nextElementSibling;
    const isShow = area.classList.contains('show');
    if (isShow) {
      area.classList.remove('show');
      btn.textContent = '查看解析';
      btn.style.color = '#374151';
      btn.style.background = '#fff';
      btn.style.borderColor = '#d1d5db';
    } else {
      area.classList.add('show');
      btn.textContent = '收起解析';
      btn.style.color = '#4f46e5';
      btn.style.background = '#eef2ff';
      btn.style.borderColor = '#c7d2fe';
    }
  };

  document.addEventListener("DOMContentLoaded", init);
</script>

</body>
</html>